---
- name: Instal Grafana
  hosts: all
  become: yes  # This is required to gain sudo privileges

  vars_files:
    - vars.yml
    - vault/api_key.yml

  handlers:
    - name: reload systemd
      ansible.builtin.systemd:
        daemon_reload: true

    - name: restart grafana
      ansible.builtin.systemd:
        name: grafana-server
        state: restarted
        enabled: true  # This ensures the service is enabled to start at boot    

  tasks:
    - name: Download Grafana GPG key
      ansible.builtin.get_url:
        url: https://rpm.grafana.com/gpg.key
        dest: /tmp/gpg.key
        mode: '0644'

    - name: Import GPG key
      ansible.builtin.rpm_key:
        state: present
        key: /tmp/gpg.key
      notify: reload systemd

    - name: Copy Grafana repo file
      ansible.builtin.copy:
        src: grafana.repo # Update this path to where you stored the file
        dest: /etc/yum.repos.d/grafana.repo
        mode: '0644'

    - name: Install Grafana Enterprise
      ansible.builtin.dnf:
        name: grafana-enterprise
        state: present
      notify: restart grafana

    - name: Ensure Grafana is started and enabled
      ansible.builtin.systemd:
        name: grafana-server
        state: started
        enabled: yes

    - name: Ensure firewalld is stopped (since this is a test server).
      service: name=firewalld state=stopped

# need to create seperate Prometheus playbook
# need to change this to be idempotent.
    - name: Download Prometheus
      ansible.builtin.unarchive:
        src: "{{ prometheus_url }}"
        dest: "{{ dest_dir }}"
        creates: "{{ dest_dir }}/prometheus/"
        remote_src: true
# cannot do checksum with unarchive. Change this to get_url then unarchive.

    - name: Find Prometheus directory
      ansible.builtin.find:
        paths: "{{ dest_dir }}"
        patterns: 'prometheus-*'
        file_type: directory
      register: prometheus_dir
 
    - name: print prometheus directory
      ansible.builtin.debug:
        var: prometheus_dir.files[0].path
# Might need to change perms on this file since the api key is in plain text.
    - name: Copy Prometheus configuration template
      ansible.builtin.template:
        src: prometheus.yml.j2
        dest: "{{ prometheus_dir.files[0].path }}/prometheus.yml"
        force: yes
# I access the dir path this way because the find module returned a complex object 
# that is basically an array. 

# need to add task to actually start the 
# prometheus service:  " ./prometheus --config.file=./prometheus.yml"

# certbot is already installed on magpie via snap. It appears that I can still 
# use the geerlingguy.certbot role to manage certs. Might try that. 

  roles:
    - role: geerlingguy.certbot
      vars:
        certbot_admin_eamil: di_notifications@utk.edu
        certbot_install_method: snap
        certbot_create_if_missing: true
        certbot_create_method: apache
        certbot_certs:
          - domains: 
            - "grafana.lib.utk.edu"

      